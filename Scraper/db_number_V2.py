import asyncio
import re
from supabase import create_client

# 1. Configuration
SUPABASE_URL = "https://dbpbeuyrvsagptqwllrr.supabase.co"
SUPABASE_SERVICE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRicGJldXlydnNhZ3B0cXdsbHJyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODQ4MzQzMCwiZXhwIjoyMDg0MDU5NDMwfQ.FulpG5B-IyXdCV_dULVrPFFeQgFFTMdPcunTjuQ6CE0"

supabase = create_client(SUPABASE_URL, SUPABASE_SERVICE_KEY)

# 2. Raw Text Data
RAW_TEXT = """
  BENIN 558	2290140408772
BENIN 558	2290140407056
BENIN 558	2290140408226
BENIN 558	2290140402429
BENIN 558	2290140400116
BENIN 558	2290140401187
BENIN 558	2290140409836
BENIN 558	2290140405680
BENIN 558	2290140403110
BENIN 558	2290140408927
BENIN 558	2290140400835
BENIN 558	2290140402206
BENIN 558	2290140409614
BENIN 558	2290140403293
BENIN 558	2290140403940
BENIN 558	2290140404479
BENIN 558	2290140404813
BENIN 558	2290140405001
BENIN 558	2290140405183
BENIN 558	2290140400038
BENIN 558	2290140403512
BENIN 558	2290140404861
BENIN 558	2290140402794
BENIN 558	2290140407901
BENIN 558	2290140409382
BENIN 558	2290140404981
BENIN 558	2290140408181
BENIN 558	2290140408873
BENIN 558	2290140409703
BENIN 558	2290140409202
BENIN 558	2290140404175
BENIN 558	2290140407916
BENIN 558	2290140401383
BENIN 558	2290140405889
BENIN 558	2290140407370
BENIN 558	2290140401889
BENIN 558	2290140405176
BENIN 558	2290140404910
BENIN 558	2290140400319
BENIN 558	2290140404512
BENIN 558	2290140405400
BENIN 558	2290140403263
BENIN 558	2290140409862
BENIN 558	2290140400659
BENIN 558	2290140401447
BENIN 558	2290140405090
BENIN 558	2290140401794
BENIN 558	2290140402810
BENIN 558	2290140401956
BENIN 558	2290140406830
BENIN 558	2290140404436
BENIN 558	2290140401441
BENIN 558	2290140404011
BENIN 558	2290140406078
BENIN 558	2290140404155
BENIN 558	2290140405087
BENIN 558	2290140401610
BENIN 558	2290140406460
BENIN 558	2290140403402
BENIN 558	2290140402542
BENIN 558	2290140409041
BENIN 558	2290140404537
BENIN 558	2290140409761
BENIN 558	2290140405106
BENIN 558	2290140408341
BENIN 558	2290140403907
BENIN 558	2290140406922
BENIN 558	2290140401142
BENIN 558	2290140409709
BENIN 558	2290140402504
BENIN 558	2290140404695
BENIN 558	2290140403887
BENIN 558	2290140408778
BENIN 558	2290140405021
BENIN 558	2290140405501
BENIN 558	2290140402451
BENIN 558	2290140405593
BENIN 558	2290140402725
BENIN 558	2290140409750
BENIN 558	2290140409455
BENIN 558	2290140401324
BENIN 558	2290140400058
BENIN 558	2290140409371
BENIN 558	2290140408892
BENIN 558	2290140408984
BENIN 558	2290140404221
BENIN 558	2290140403937
BENIN 558	2290140405882
BENIN 558	2290140406662
BENIN 558	2290140403235
BENIN 558	2290140408821
BENIN 558	2290140406371
BENIN 558	2290140405439
BENIN 558	2290140404846
BENIN 558	2290140403050
BENIN 558	2290140407778
BENIN 558	2290140408113
BENIN 558	2290140404811
BENIN 558	2290140408600
BENIN 558	2290140402152
BANGLADESH 45428	8801861686846
BANGLADESH 45428	8801861683122
BANGLADESH 45428	8801861680551
BANGLADESH 45428	8801861686097
BANGLADESH 45428	8801861689140
BANGLADESH 45428	8801861686162
BANGLADESH 45428	8801861687049
BANGLADESH 45428	8801861681575
BANGLADESH 45428	8801861680540
BANGLADESH 45428	8801861687746
BANGLADESH 45428	8801861682077
BANGLADESH 45428	8801861687213
BANGLADESH 45428	8801861689070
BANGLADESH 45428	8801861687962
BANGLADESH 45428	8801861686963
BANGLADESH 45428	8801861682560
BANGLADESH 45428	8801861686292
BANGLADESH 45428	8801861688491
BANGLADESH 45428	8801861684954
BANGLADESH 45428	8801861681983
BANGLADESH 45428	8801861681601
BANGLADESH 45428	8801861680791
BANGLADESH 45428	8801861680889
BANGLADESH 45428	8801861682997
BANGLADESH 45428	8801861687237
BANGLADESH 45428	8801861682101
BANGLADESH 45428	8801861686798
BANGLADESH 45428	8801861680185
BANGLADESH 45428	8801861688737
BANGLADESH 45428	8801861688751
BANGLADESH 45428	8801861683775
BANGLADESH 45428	8801861680383
BANGLADESH 45428	8801861680203
BANGLADESH 45428	8801861680674
BANGLADESH 45428	8801861685622
BANGLADESH 45428	8801861682754
BANGLADESH 45428	8801861680921
BANGLADESH 45428	8801861682524
BANGLADESH 45428	8801861680599
BANGLADESH 45428	8801861682647
BANGLADESH 45428	8801861681897
BANGLADESH 45428	8801861680425
BANGLADESH 45428	8801861685990
BANGLADESH 45428	8801861684765
BANGLADESH 45428	8801861682842
BANGLADESH 45428	8801861681673
BANGLADESH 45428	8801861680045
BANGLADESH 45428	8801861685806
BANGLADESH 45428	8801861687736
BANGLADESH 45428	8801861689077
BANGLADESH 45428	8801861683152
BANGLADESH 45428	8801861684859
BANGLADESH 45428	8801861687241
BANGLADESH 45428	8801861686933
BANGLADESH 45428	8801861682314
BANGLADESH 45428	8801861685362
BANGLADESH 45428	8801861686052
BANGLADESH 45428	8801861688540
BANGLADESH 45428	8801861680067
BANGLADESH 45428	8801861680528
BANGLADESH 45428	8801861683833
BANGLADESH 45428	8801861689445
BANGLADESH 45428	8801861683677
BANGLADESH 45428	8801861684580
BANGLADESH 45428	8801861683801
BANGLADESH 45428	8801861688258
BANGLADESH 45428	8801861682941
BANGLADESH 45428	8801861680963
BANGLADESH 45428	8801861684692
BANGLADESH 45428	8801861682401
BANGLADESH 45428	8801861682358
BANGLADESH 45428	8801861684540
BANGLADESH 45428	8801861684575
BANGLADESH 45428	8801861682769
BANGLADESH 45428	8801861680051
BANGLADESH 45428	8801861686276
BANGLADESH 45428	8801861682364
BANGLADESH 45428	8801861685975
BANGLADESH 45428	8801861681275
BANGLADESH 45428	8801861688149
BANGLADESH 45428	8801861683433
BANGLADESH 45428	8801861685653
BANGLADESH 45428	8801861687888
BANGLADESH 45428	8801861687773
BANGLADESH 45428	8801861686198
BANGLADESH 45428	8801861681295
BANGLADESH 45428	8801861685550
BANGLADESH 45428	8801861683004
BANGLADESH 45428	8801861688102
BANGLADESH 45428	8801861687934
BANGLADESH 45428	8801861688493
BANGLADESH 45428	8801861686956
BANGLADESH 45428	8801861683051
BANGLADESH 45428	8801861682644
BANGLADESH 45428	8801861684891
BANGLADESH 45428	8801861681112
BANGLADESH 45428	8801861687708
BANGLADESH 45428	8801861685122
BANGLADESH 45428	8801861684085
BANGLADESH 45428	8801861687628
BANGLADESH 40388	8801872986290
BANGLADESH 40388	8801872982525
BANGLADESH 40388	8801872986829
BANGLADESH 40388	8801872985022
BANGLADESH 40388	8801872987166
BANGLADESH 40388	8801872986425
BANGLADESH 40388	8801872984222
BANGLADESH 40388	8801872980802
BANGLADESH 40388	8801872982936
BANGLADESH 40388	8801872982947
BANGLADESH 40388	8801872980813
BANGLADESH 40388	8801872981404
BANGLADESH 40388	8801872989581
BANGLADESH 40388	8801872985235
BANGLADESH 40388	8801872989091
BANGLADESH 40388	8801872980326
BANGLADESH 40388	8801872983121
BANGLADESH 40388	8801872984582
BANGLADESH 40388	8801872986598
BANGLADESH 40388	8801872982740
BANGLADESH 40388	8801872981385
BANGLADESH 40388	8801872982412
BANGLADESH 40388	8801872981834
BANGLADESH 40388	8801872981487
BANGLADESH 40388	8801872983241
BANGLADESH 40388	8801872980721
BANGLADESH 40388	8801872986734
BANGLADESH 40388	8801872985007
BANGLADESH 40388	8801872982231
BANGLADESH 40388	8801872982158
BANGLADESH 40388	8801872985013
BANGLADESH 40388	8801872983978
BANGLADESH 40388	8801872988316
BANGLADESH 40388	8801872984733
BANGLADESH 40388	8801872985267
BANGLADESH 40388	8801872987141
BANGLADESH 40388	8801872985365
BANGLADESH 40388	8801872989783
BANGLADESH 40388	8801872980161
BANGLADESH 40388	8801872980354
BANGLADESH 40388	8801872986784
BANGLADESH 40388	8801872984514
BANGLADESH 40388	8801872982528
BANGLADESH 40388	8801872980995
BANGLADESH 40388	8801872980296
BANGLADESH 40388	8801872985625
BANGLADESH 40388	8801872983665
BANGLADESH 40388	8801872985956
BANGLADESH 40388	8801872987950
BANGLADESH 40388	8801872981057
BANGLADESH 40388	8801872981722
BANGLADESH 40388	8801872982146
BANGLADESH 40388	8801872983908
BANGLADESH 40388	8801872980447
BANGLADESH 40388	8801872985367
BANGLADESH 40388	8801872982331
BANGLADESH 40388	8801872981455
BANGLADESH 40388	8801872984993
BANGLADESH 40388	8801872987788
BANGLADESH 40388	8801872988258
BANGLADESH 40388	8801872983650
BANGLADESH 40388	8801872989695
BANGLADESH 40388	8801872989645
BANGLADESH 40388	8801872981361
BANGLADESH 40388	8801872983513
BANGLADESH 40388	8801872988998
BANGLADESH 40388	8801872987955
BANGLADESH 40388	8801872986371
BANGLADESH 40388	8801872980554
BANGLADESH 40388	8801872980235
BANGLADESH 40388	8801872983116
BANGLADESH 40388	8801872986896
BANGLADESH 40388	8801872986749
BANGLADESH 40388	8801872984899
BANGLADESH 40388	8801872987036
BANGLADESH 40388	8801872981195
BANGLADESH 40388	8801872988303
BANGLADESH 40388	8801872983764
BANGLADESH 40388	8801872985195
BANGLADESH 40388	8801872981736
BANGLADESH 40388	8801872983789
BANGLADESH 40388	8801872987216
BANGLADESH 40388	8801872982939
BANGLADESH 40388	8801872980049
BANGLADESH 40388	8801872985338
BANGLADESH 40388	8801872981916
BANGLADESH 40388	8801872987436
BANGLADESH 40388	8801872983902
BANGLADESH 40388	8801872988027
BANGLADESH 40388	8801872987738
BANGLADESH 40388	8801872982345
BANGLADESH 40388	8801872984146
BANGLADESH 40388	8801872980538
BANGLADESH 40388	8801872986948
BANGLADESH 40388	8801872985014
BANGLADESH 40388	8801872981554
BANGLADESH 40388	8801872981156
BANGLADESH 40388	8801872980450
BANGLADESH 40388	8801872987564
BANGLADESH 40388	8801872985895

""" # Paste your full list here

def parse_raw_data(text):
    # This pattern captures: [Country Name] [ID] [Full Number]
    # It allows for multiple spaces between columns
    pattern = r"([A-Z\s]+)\s+\d+\s+(\d+)"
    matches = re.findall(pattern, text)
    
    formatted_data = []
    seen_numbers = set()
    
    # Map to identify where to split the number
    country_map = {
        "229": "BENIN",
        "225": "IVORY COAST",
        "228": "TOGO",
        "261": "MADAGASCAR",
        "95": "MYANMAR",
        "232": "SIERRA LEONE",
        "977": "NEPAL",
        "880": "NEPAL"
        }

    for country_name_raw, full_number in matches:
        country_name = country_name_raw.strip()
        
        for code in country_map.keys():
            if full_number.startswith(code):
                cc = code
                local_num = full_number[len(code):]
                
                if local_num not in seen_numbers:
                    # EXACT MATCH TO YOUR TABLE COLUMNS:
                    # country_name, country_code, number
                    formatted_data.append({
                        "country_name": country_name,
                        "country_code": cc,
                        "number": local_num
                    })
                    seen_numbers.add(local_num)
                break
            
    return formatted_data

async def main():
    cleaned_list = parse_raw_data(RAW_TEXT)
    
    if not cleaned_list:
        print("‚ùå No data found. Check your RAW_TEXT format.")
        return

    print(f"üì¶ Parsed {len(cleaned_list)} unique numbers.")

    try:
        # 1. Clear old data
        print("Wiping old data from Supabase...")
        # Note: If blocked_numbers references 'numbers', we clear it first
        try:
            supabase.table("blocked_numbers").delete().neq("number", "id").execute()
        except:
            pass # Skip if table doesn't exist
            
        supabase.table("numbers").delete().neq("number", "id").execute()

        # 2. Batch Upload
        print(f"Uploading {len(cleaned_list)} rows to Supabase...")
        supabase.table("numbers").insert(cleaned_list).execute()
        
        print(f"üöÄ Success! Your database is updated.")
        
    except Exception as e:
        print(f"‚ùå Supabase Error: {e}")

if __name__ == "__main__":
    asyncio.run(main())